<div class="form-container">
  <h2>{{ editId > 0 ? 'Fahrzeug bearbeiten' : 'Neues Fahrzeug hinzufügen' }}</h2>
  <br/>
  <form [formGroup]="form" (ngSubmit)="submit()">

    <input formControlName="id" type="hidden" />

    <div class="form-section">
      <h3>Grunddaten</h3>
      
      <div class="form-row">
        <label for="customerId">Kunde *</label>
        <select id="customerId" 
                formControlName="customerId"
                [class.invalid]="isFieldInvalid('customerId')">
          <option [ngValue]="null">Bitte Kunde auswählen</option>
          @for (customer of customers$ | async; track customer.customerId) {
            <option [ngValue]="customer.customerId">
              {{ customer.customerId }} – {{ customer.lastName }}, {{ customer.firstName }}
            </option>
          }
        </select>
        <small class="error" *ngIf="isFieldInvalid('customerId')">
          {{ getFieldError('customerId') }}
        </small>
      </div>

      <div class="form-row">
        <label for="make">Marke *</label>
        <input id="make" 
               formControlName="make" 
               type="text" 
               [class.invalid]="isFieldInvalid('make')" />
        <small class="error" *ngIf="isFieldInvalid('make')">
          {{ getFieldError('make') }}
        </small>
      </div>

      <div class="form-row">
        <label for="model">Modell *</label>
        <input id="model" 
               formControlName="model" 
               type="text" 
               [class.invalid]="isFieldInvalid('model')" />
        <small class="error" *ngIf="isFieldInvalid('model')">
          {{ getFieldError('model') }}
        </small>
      </div>

      <div class="form-row">
        <label for="initialRegistration">Erstzulassung</label>
        <input id="initialRegistration" 
               formControlName="initialRegistration" 
               type="date" />
      </div>

      <div class="form-row">
        <label for="color">Farbe</label>
        <input id="color" 
               formControlName="color" 
               type="text" />
      </div>

      <div class="form-row">
        <label for="status">Status *</label>
        <select id="status" 
                formControlName="status" 
                [class.invalid]="isFieldInvalid('status')">
          <option value="Verfügbar">Verfügbar</option>
          <option value="Reserviert">Reserviert</option>
          <option value="Verkauft">Verkauft</option>
        </select>
        <small class="error" *ngIf="isFieldInvalid('status')">
          {{ getFieldError('status') }}
        </small>
      </div>
    </div>

    <div class="form-section">
      <h3>Ausstattung</h3>
      
      <div class="predefined-equipment">
        <label>Verfügbare Ausstattungsmerkmale:</label>
        <div class="equipment-buttons">
          @for (feature of availableEquipment; track feature.id) {
            <button type="button" 
                    class="btn-export-csv" 
                    (click)="addPredefinedEquipment(feature.id)">
              + {{ feature.name }}
            </button>
          }
        </div>
      </div>

      <div class="equipment-list" formArrayName="equipmentFeatureIds">
        @for (control of equipmentFeatureIdsArray.controls; track $index; let i = $index) {
          <div class="equipment-item">
            <select [formControlName]="i" class="equipment-select">
              <option [ngValue]="null">Bitte auswählen</option>
              @for (feature of availableEquipment; track feature.id) {
                <option [ngValue]="feature.id">{{ feature.name }}</option>
              }
            </select>
            <button type="button" 
                    class="btn-remove" 
                    (click)="removeEquipmentFeature(i)">
              ✕
            </button>
          </div>
        }
      </div>

      <button type="button" 
              class="btn-export-csv" 
              (click)="addEquipmentFeature()">
        + Weiteres Merkmal hinzufügen
      </button>
    </div>

    <div class="form-actions">
      <button type="button" 
              class="btn-cancel" 
              (click)="resetForm()">
        Abbrechen
      </button>
      <button type="submit" 
              class="btn-submit" 
              [disabled]="form.invalid">
        {{ editId > 0 ? 'Aktualisieren' : 'Hinzufügen' }}
      </button>
    </div>
  </form>
</div>
